# ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Apple In-App Purchases - –ó–ê–í–ï–†–®–ï–ù–û

## ‚úÖ –°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã Apple IAP —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.

---

## üìã –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

### –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å (aviapoint_server):

1. ‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î** (`073_add_iap_support_to_payments.sql`)
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è: `payment_source`, `apple_transaction_id`, `apple_original_transaction_id`
   - –°–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

2. ‚úÖ **API Endpoint** (`POST /api/payments/verify-iap`)
   - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç receipt data –æ—Ç iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ Apple App Store Server API
   - –°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

3. ‚úÖ **–°–µ—Ä–≤–∏—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏** (`AppleIAPService`)
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å App Store Server API
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Sandbox –∏ Production
   - JWT –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

4. ‚úÖ **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**
   - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
   - Key ID, Issuer ID, Private Key, Bundle ID

### –§—Ä–æ–Ω—Ç–µ–Ω–¥ (aviapoint):

1. ‚úÖ **–ü–∞–∫–µ—Ç `in_app_purchase`** –¥–æ–±–∞–≤–ª–µ–Ω –≤ `pubspec.yaml`

2. ‚úÖ **–°–µ—Ä–≤–∏—Å IAP** (`IAPService`)
   - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IAP
   - –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   - –ü–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
   - –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

3. ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ PaymentHelper**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
   - iOS ‚Üí Apple IAP
   - Web/Android ‚Üí YooKassa

4. ‚úÖ **Product ID –ø—Ä–æ–≤–µ—Ä–µ–Ω**
   - –ö–æ–¥: `com.aviapoint.subscription.rosaviatest.yearly`
   - App Store Connect: `com.aviapoint.subscription.rosaviatest.yearly`
   - ‚úÖ **–°–æ–≤–ø–∞–¥–∞–µ—Ç**

### App Store Connect:

1. ‚úÖ **–ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞**
   - –¢–∏–ø: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
   - –ü–µ—Ä–∏–æ–¥: 1 –≥–æ–¥
   - Product ID: `com.aviapoint.subscription.rosaviatest.yearly`
   - –°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ

2. ‚úÖ **API –∫–ª—é—á–∏ –ø–æ–ª—É—á–µ–Ω—ã**
   - Key ID: `R6LQF5HNM8`
   - Issuer ID: `367b4fc3-8a84-4c57-bce7-215dfb51aa8f`
   - Private Key: —Å–∫–∞—á–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
   - Bundle ID: `ru.dartflutter.aviapoint`

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å build_runner (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–∏):

```bash
cd ../aviapoint
flutter pub get
dart run build_runner build --delete-conflicting-outputs
```

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞):

–ú–∏–≥—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞. –ï—Å–ª–∏ –Ω–µ—Ç:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
docker exec -e PGPASSWORD=uOTC0OWjMVIoaRxI aviapoint-postgres psql -U postgres -d aviapoint -f /path/to/migrations/073_add_iap_support_to_payments.sql
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
```bash
APPLE_IAP_KEY_ID=R6LQF5HNM8
APPLE_IAP_ISSUER_ID=367b4fc3-8a84-4c57-bce7-215dfb51aa8f
APPLE_IAP_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n..."
APPLE_BUNDLE_ID=ru.dartflutter.aviapoint
```

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

#### –ù–∞ iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (–Ω–µ —Å–∏–º—É–ª—è—Ç–æ—Ä):
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Sandbox Test Account
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∏–∑:
   - –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –≠–∫—Ä–∞–Ω –ø—Ä–æ—Ñ–∏–ª—è
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:
- ‚úÖ –ü–æ–∫—É–ø–∫–∞ —á–µ—Ä–µ–∑ Apple IAP
- ‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- ‚úÖ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ë–î
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏

---

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è:

1. **IAP —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö** (–Ω–µ –≤ —Å–∏–º—É–ª—è—Ç–æ—Ä–µ)
2. **–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω—É–∂–µ–Ω Sandbox Test Account** –≤ App Store Connect
3. **Product ID –¥–æ–ª–∂–µ–Ω —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å** - ‚úÖ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ
4. **–ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è** –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
5. **–ü–µ—Ä–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤–º–µ—Å—Ç–µ —Å –≤–µ—Ä—Å–∏–µ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** –≤ App Store Connect

---

## üîç –ì–¥–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É:

### –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:
```bash
docker logs aviapoint-server --tail=100 | grep -i "iap\|apple"
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:
```sql
SELECT * FROM payments WHERE payment_source = 'apple_iap';
SELECT * FROM subscriptions WHERE user_id = <user_id>;
```

### iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –≠–∫—Ä–∞–Ω –ø—Ä–æ—Ñ–∏–ª—è
- –ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –¥–æ–ª–∂–Ω–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ–¥–ø–∏—Å–∫–∞

---

## ‚úÖ –ò—Ç–æ–≥:

**–í—Å–µ –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** 

–û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å build_runner (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–∏)
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ —Å Sandbox Test Account

–£–¥–∞—á–∏! üöÄ
