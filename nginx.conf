# ============================================================================
# NGINX CONFIGURATION FOR AVIAPOINT SERVER
# ============================================================================
# Основная конфигурация nginx для Flutter Web приложения с Dart backend API
# ============================================================================

# Пользователь и процессы
user nginx;
worker_processes auto;  # Автоматическое определение количества worker процессов
error_log /var/log/nginx/error.log warn;  # Логи ошибок уровня warning и выше
pid /var/run/nginx.pid;  # Файл с PID главного процесса

# Настройки событий (event-driven модель)
events {
    worker_connections 1024;  # Максимальное количество соединений на worker
}

# HTTP конфигурация
http {
    # MIME типы для правильной обработки файлов
    include /etc/nginx/mime.types;
    default_type application/octet-stream;  # Тип по умолчанию для неизвестных файлов

    # Формат логов доступа
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;  # Логирование всех запросов

    # Оптимизация производительности
    sendfile on;  # Использование sendfile для эффективной передачи файлов
    tcp_nopush on;  # Отправка пакетов только когда они заполнены
    tcp_nodelay on;  # Отключение алгоритма Nagle для уменьшения задержек
    keepalive_timeout 65;  # Таймаут keep-alive соединений (секунды)
    types_hash_max_size 2048;  # Максимальный размер хэш-таблицы MIME типов
    client_max_body_size 100M;  # Максимальный размер тела запроса (для загрузки файлов)

    # ========================================================================
    # GZIP СЖАТИЕ
    # ========================================================================
    # Сжатие ответов для уменьшения трафика и ускорения загрузки
    gzip on;  # Включить gzip сжатие
    gzip_vary on;  # Добавлять заголовок Vary: Accept-Encoding
    gzip_min_length 1024;  # Минимальный размер файла для сжатия (байты)
    gzip_types text/plain text/css text/xml text/javascript 
               application/x-javascript application/xml+rss 
               application/json application/javascript;  # Типы файлов для сжатия

    # ========================================================================
    # RATE LIMITING (ОГРАНИЧЕНИЕ ЧАСТОТЫ ЗАПРОСОВ)
    # ========================================================================
    # Защита от DDoS и злоупотреблений
    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;  # Общее ограничение: 10 запросов/сек на IP
    limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;  # API ограничение: 30 запросов/сек на IP

    # ========================================================================
    # UPSTREAM (BACKEND СЕРВЕР)
    # ========================================================================
    # Определение backend сервера (Dart приложение в Docker)
    upstream backend {
        server app:8080;  # Имя контейнера и порт backend сервера
    }

    # ========================================================================
    # HTTP -> HTTPS РЕДИРЕКТ
    # ========================================================================
    # Все HTTP запросы перенаправляются на HTTPS для безопасности
    server {
        listen 80;  # IPv4 порт 80 (HTTP)
        listen [::]:80;  # IPv6 порт 80 (HTTP)
        server_name avia-point.com www.avia-point.com;  # Домены для этого сервера
        
        # ====================================================================
        # Let's Encrypt ACME Challenge
        # ====================================================================
        # Путь для верификации домена при получении/обновлении SSL сертификата
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;  # Директория для certbot верификации
        }
        
        # ====================================================================
        # РЕДИРЕКТ ВСЕХ ОСТАЛЬНЫХ ЗАПРОСОВ НА HTTPS
        # ====================================================================
        location / {
            return 301 https://$host$request_uri;  # Постоянный редирект (301) на HTTPS
        }
    }

    # ========================================================================
    # HTTPS СЕРВЕР (ОСНОВНОЙ)
    # ========================================================================
    server {
        listen 443 ssl http2;  # IPv4 порт 443 с SSL и HTTP/2
        listen [::]:443 ssl http2;  # IPv6 порт 443 с SSL и HTTP/2
        server_name avia-point.com www.avia-point.com;  # Домены для этого сервера

        # ====================================================================
        # КОРНЕВАЯ ДИРЕКТОРИЯ ДЛЯ FLUTTER WEB
        # ====================================================================
        # ВАЖНО: здесь должно лежать содержимое build/web (index.html, main.dart.js, assets и т.д.)
        root /home/aviapoint;  # Корневая директория для статических файлов Flutter Web
        index index.html;  # Файл по умолчанию для директорий

        # ====================================================================
        # SSL СЕРТИФИКАТЫ (Let's Encrypt)
        # ====================================================================
        ssl_certificate /etc/letsencrypt/live/avia-point.com/fullchain.pem;  # Полная цепочка сертификатов
        ssl_certificate_key /etc/letsencrypt/live/avia-point.com/privkey.pem;  # Приватный ключ

        # ====================================================================
        # SSL КОНФИГУРАЦИЯ
        # ====================================================================
        ssl_protocols TLSv1.2 TLSv1.3;  # Разрешенные версии TLS (безопасные)
        ssl_ciphers HIGH:!aNULL:!MD5;  # Сильные шифры, исключая слабые
        ssl_prefer_server_ciphers on;  # Приоритет серверных шифров
        ssl_session_cache shared:SSL:10m;  # Кэш SSL сессий (10MB)
        ssl_session_timeout 10m;  # Таймаут SSL сессии (10 минут)

        # ====================================================================
        # SECURITY HEADERS (ЗАГОЛОВКИ БЕЗОПАСНОСТИ)
        # ====================================================================
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        # HSTS: принудительное использование HTTPS на 1 год для всех поддоменов

        add_header X-Frame-Options "SAMEORIGIN" always;
        # Защита от clickjacking: разрешить встраивание только с того же домена

        add_header X-Content-Type-Options "nosniff" always;
        # Запрет MIME-sniffing: браузер не будет угадывать тип контента

        add_header X-XSS-Protection "1; mode=block" always;
        # Включение XSS фильтра в старых браузерах

        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        # Политика referrer: не отправлять referrer при переходе с HTTPS на HTTP

        # ====================================================================
        # ПУБЛИЧНЫЕ АССЕТЫ BACKEND (СТАТИЧЕСКИЕ ФАЙЛЫ)
        # ====================================================================
        # Статические файлы из /app/public/ (изображения, видео, PDF и т.д.)
        # Frontend формирует URL как /public/normal/..., /public/stories/... и т.д.
        location ^~ /public/ {
            root /app;  # Корневая директория: /app/public/...
            expires 30d;  # Кэширование на 30 дней
            add_header Cache-Control "public, immutable";  # Файлы не изменяются, можно кэшировать
        }

        # ====================================================================
        # ПРОФИЛЬНЫЕ ФОТОГРАФИИ (/profiles/)
        # ====================================================================
        # Фотографии профилей пользователей из /app/public/profiles/
        # Обрабатываем запросы как /profiles/... (без /public/ в URL)
        # для обратной совместимости, если фронтенд формирует URL без /public/
        location ^~ /profiles/ {
            root /app/public;  # Корневая директория: /app/public/profiles/...
            expires 7d;  # Кэширование на 7 дней (фото могут обновляться)
            add_header Cache-Control "public";  # Можно кэшировать, но не immutable (фото могут меняться)
        }

        # ====================================================================
        # WASM ФАЙЛЫ (WebAssembly)
        # ====================================================================
        # WebAssembly файлы требуют правильного MIME типа и не должны сжиматься
        
        # Конкретный файл sqlite3mc.wasm (приоритет над общим правилом)
        location = /sqlite3mc.wasm {
            default_type application/wasm;  # Правильный MIME тип для WASM
            expires 30d;  # Кэширование на 30 дней
            add_header Cache-Control "public, immutable" always;  # Файл не изменяется
            access_log off;  # Не логировать запросы к этому файлу
            gzip off;  # НЕ сжимать WASM файлы (они уже сжаты)
        }
        
        # Все остальные .wasm файлы
        location ~* \.wasm$ {
            default_type application/wasm;  # Правильный MIME тип для WASM
            expires 30d;  # Кэширование на 30 дней
            add_header Cache-Control "public, immutable" always;  # Файл не изменяется
            access_log off;  # Не логировать запросы к WASM файлам
            gzip off;  # НЕ сжимать WASM файлы (они уже сжаты)
        }

        # ====================================================================
        # FLUTTER WEB ASSETS (СТАТИЧЕСКИЕ ФАЙЛЫ ПРИЛОЖЕНИЯ)
        # ====================================================================
        
        # ====================================================================
        # main.dart.js — БЕЗ ЖЁСТКОГО КЭША
        # ====================================================================
        # Основной JavaScript файл приложения - может обновляться при деплое
        # Поэтому не кэшируем агрессивно, чтобы пользователи получали обновления
        # ВАЖНО: отключаем Range requests, чтобы избежать ошибки 206 Partial Content
        location = /main.dart.js {
            try_files $uri =404;  # Если файл не найден - 404
            add_header Cache-Control "no-cache, no-store, must-revalidate";  # Не кэшировать
            add_header Pragma "no-cache";  # Совместимость со старыми браузерами
            add_header Expires "0";  # Истекает сразу
            add_header Accept-Ranges none;  # Отключить Range requests (предотвращает 206)
            max_ranges 0;  # Отключить поддержку Range requests
        }

        # ====================================================================
        # flutter_service_worker.js — БЕЗ IMMUTABLE
        # ====================================================================
        # Service Worker для PWA функциональности - может обновляться
        # ВАЖНО: отключаем Range requests, чтобы избежать ошибки 206 Partial Content
        # Service Worker Cache API не поддерживает кэширование частичных ответов
        location = /flutter_service_worker.js {
            try_files $uri =404;  # Если файл не найден - 404
            add_header Cache-Control "no-cache, no-store, must-revalidate";  # Не кэшировать
            add_header Pragma "no-cache";  # Совместимость со старыми браузерами
            add_header Expires "0";  # Истекает сразу
            add_header Accept-Ranges none;  # Отключить Range requests (предотвращает 206)
            max_ranges 0;  # Отключить поддержку Range requests
        }

        # ====================================================================
        # ОСТАЛЬНАЯ СТАТИКА (JS, CSS, ШРИФТЫ, ИЗОБРАЖЕНИЯ, ИКОНКИ)
        # ====================================================================
        # Эти файлы имеют хэши в именах (например, main.dart.js?hash=abc123)
        # Поэтому их можно кэшировать агрессивно - при обновлении имя изменится
        # ВАЖНО: отключаем Range requests для файлов, которые кэширует Service Worker
        location ~* \.(js|css|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot|ico)$ {
            try_files $uri =404;  # Если файл не найден - 404 (не fallback на index.html)
            expires 30d;  # Кэширование на 30 дней
            add_header Cache-Control "public, immutable";  # Файл не изменяется
            access_log off;  # Не логировать запросы к статике (уменьшает нагрузку)
            add_header Accept-Ranges none;  # Отключить Range requests (предотвращает 206 для Service Worker)
            max_ranges 0;  # Отключить поддержку Range requests
        }

        # ====================================================================
        # HTML И DART ФАЙЛЫ (БЕЗ .JSON, ЧТОБЫ НЕ ЛОВИТЬ API)
        # ====================================================================
        # HTML и Dart файлы не должны кэшироваться, чтобы получать обновления
        # Исключаем .json, чтобы не перехватывать API ответы
        location ~* \.(html|dart)$ {
            try_files $uri =404;  # Если файл не найден - 404
            add_header Cache-Control "no-cache, no-store, must-revalidate";  # Не кэшировать
            add_header Pragma "no-cache";  # Совместимость со старыми браузерами
            add_header Expires "0";  # Истекает сразу
        }

        # ====================================================================
        # FAVICON (ИКОНКА САЙТА)
        # ====================================================================
        # Браузеры часто запрашивают /favicon.ico, перенаправляем на /favicon.png
        location = /favicon.ico {
            return 301 /favicon.png;  # Постоянный редирект на favicon.png
        }
        
        # Обработка favicon.png
        location = /favicon.png {
            try_files $uri =404;  # Если файл не найден - 404
            expires 7d;  # Кэширование на 7 дней
            add_header Cache-Control "public, immutable";  # Файл не изменяется
            access_log off;  # Не логировать запросы к favicon
        }

        # ====================================================================
        # API PROXY (ПРОКСИРОВАНИЕ НА BACKEND)
        # ====================================================================
        # Все запросы к /api/... проксируются на Dart backend сервер
        # Backend уже настроен на обработку путей с префиксом /api/
        location /api/ {
            # Ограничение частоты запросов для API
            limit_req zone=api burst=50 nodelay;
            # zone=api: использовать зону api (30 req/s)
            # burst=50: разрешить до 50 запросов сверх лимита
            # nodelay: не задерживать запросы, сразу обрабатывать

            # ================================================================
            # ПРОКСИРОВАНИЕ НА BACKEND
            # ================================================================
            # ВАЖНО: без слэша в конце, чтобы /api/auth -> /api/auth (а не /auth)
            proxy_pass http://backend;

            # HTTP версия для проксирования
            proxy_http_version 1.1;  # Использовать HTTP/1.1 для keep-alive

            # Заголовки для правильной работы прокси
            proxy_set_header Host $host;  # Оригинальный Host заголовок
            proxy_set_header X-Real-IP $remote_addr;  # Реальный IP клиента
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Цепочка IP адресов
            proxy_set_header X-Forwarded-Proto $scheme;  # Оригинальный протокол (http/https)
            proxy_set_header X-Forwarded-Host $host;  # Оригинальный Host
            proxy_set_header Connection "";  # Закрыть соединение после ответа
            proxy_set_header Upgrade $http_upgrade;  # Для WebSocket (если нужно)

            # Оптимизация проксирования
            proxy_buffering off;  # Отключить буферизацию (для streaming)
            proxy_cache off;  # Отключить кэширование ответов
            proxy_connect_timeout 60s;  # Таймаут подключения к backend (60 сек)
            proxy_send_timeout 60s;  # Таймаут отправки запроса (60 сек)
            proxy_read_timeout 60s;  # Таймаут чтения ответа (60 сек)
        }

        # ====================================================================
        # FLUTTER WEB SPA (SINGLE PAGE APPLICATION)
        # ====================================================================
        # Flutter Web - это SPA, все маршруты обрабатываются на клиенте
        # Поэтому для любого пути, который не является файлом, отдаём index.html

        # ====================================================================
        # КОРНЕВОЙ ПУТЬ (/)
        # ====================================================================
        # Точное совпадение для корневого пути - отдаём index.html напрямую
        location = / {
            try_files /index.html =404;  # Пробовать /index.html, если нет - 404
            add_header Cache-Control "no-cache, no-store, must-revalidate";  # Не кэшировать
            add_header Pragma "no-cache";  # Совместимость со старыми браузерами
            add_header Expires "0";  # Истекает сразу
        }

        # ====================================================================
        # ВСЕ ОСТАЛЬНЫЕ ПУТИ (SPA РОУТИНГ)
        # ====================================================================
        # Для любого другого пути:
        # 1. Пробуем найти файл по пути ($uri)
        # 2. Пробуем найти директорию ($uri/)
        # 3. Если ничего не найдено - отдаём index.html (SPA роутинг)
        # Это позволяет Flutter Router обрабатывать маршруты на клиенте
        # ВАЖНО: это правило должно быть последним, чтобы не перехватывать другие location
        location / {
            try_files $uri $uri/ /index.html;  # Файл -> Директория -> index.html
            add_header Cache-Control "no-cache, no-store, must-revalidate";  # Не кэшировать
            add_header Pragma "no-cache";  # Совместимость со старыми браузерами
            add_header Expires "0";  # Истекает сразу
            add_header X-Content-Type-Options "nosniff" always;  # Защита от MIME-sniffing
        }
    }
}
