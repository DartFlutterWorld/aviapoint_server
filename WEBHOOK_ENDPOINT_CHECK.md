# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ endpoint `/payments/webhook`

## –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **ENDPOINT –î–û–°–¢–£–ü–ï–ù –ò –†–ê–ë–û–¢–ê–ï–¢**

**URL:** `https://avia-point.com/payments/webhook`

**–û—Ç–≤–µ—Ç:** `{"status":"ok"}` (HTTP 200)

---

## –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏

### 1. SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç

‚úÖ **–í–∞–ª–∏–¥–Ω—ã–π Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç**
- –î–æ–º–µ–Ω: `avia-point.com`
- –í—ã–¥–∞–Ω: Let's Encrypt
- –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ: Feb 5 12:02:29 2026 GMT
- –ü—Ä–æ—Ç–æ–∫–æ–ª: TLSv1.3

### 2. Nginx –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ

‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ**
- –ü—É—Ç—å `/payments/webhook` –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ backend
- –ü—Ä–∞–≤–∏–ª–æ –≤ nginx.conf: `location ~ ^/(payments|...)/`
- –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### 3. Backend –æ–±—Ä–∞–±–æ—Ç–∫–∞

‚úÖ **Endpoint –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω**
- –†–æ—É—Ç: `POST /payments/webhook`
- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä: `PaymentController.webhook`
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `{"status":"ok"}`

### 4. –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞

‚úÖ **–î–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ**
- IP: `83.166.246.205:443`
- HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç
- Endpoint –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ POST –∑–∞–ø—Ä–æ—Å—ã

---

## –¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞

```bash
curl -X POST https://avia-point.com/payments/webhook \
  -H "Content-Type: application/json" \
  -d '{"event": "test", "object": {"id": "test"}}'
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{"status":"ok"}
```

**HTTP —Å—Ç–∞—Ç—É—Å:** `200 OK`

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ÆKassa

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa:

1. **URL –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
   ```
   https://avia-point.com/payments/webhook
   ```

2. **–°–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å:**
   - ‚úÖ `payment.succeeded` - –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω
   - ‚úÖ `payment.canceled` - –ø–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω
   - ‚úÖ `payment.waiting_for_capture` - –ø–ª–∞—Ç–µ–∂ –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
   - ‚úÖ `refund.succeeded` - –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:**
   - –ÆKassa –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å endpoint
   - –ï—Å–ª–∏ endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ –æ—à–∏–±–∫–∞

---

## –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ webhook

1. **–ÆKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å:**
   ```
   POST https://avia-point.com/payments/webhook
   Content-Type: application/json
   
   {
     "event": "payment.succeeded",
     "object": {
       "id": "2c5c87c0-0001-5000-8000-...",
       "status": "succeeded",
       "paid": true,
       "metadata": {
         "subscription_type": "quarterly",
         "period_days": 90,
         "user_id": 123
       }
     }
   }
   ```

2. **Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ backend:**
   - `app:8080/payments/webhook`

3. **Backend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç webhook:**
   - –ü–∞—Ä—Å–∏—Ç JSON
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–ª–∞—Ç–µ–∂ –≤ –ë–î (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω)
   - –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É (–µ—Å–ª–∏ `payment.succeeded` –∏ `paid == true`)
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{"status":"ok"}`

4. **–ÆKassa –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç:**
   - –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç `200 OK` - webhook —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º
   - –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –ÆKassa –ø–æ–≤—Ç–æ—Ä–∏—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ webhook

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
docker-compose -f docker-compose.prod.yaml logs --tail=100 app | grep -i webhook
```

**–û–∂–∏–¥–∞–µ–º—ã–µ –∑–∞–ø–∏—Å–∏:**
```
Received webhook from YooKassa: payment.succeeded
Updating payment status: 2c5c87c0-... -> succeeded (paid: true)
Payment saved to database from webhook: 2c5c87c0-... -> succeeded (paid: true, user_id: 123)
Subscription activated for user 123, payment: 2c5c87c0-..., type: quarterly, days: 90
```

---

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

**–ü—Ä–∏—á–∏–Ω—ã:**
- URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL (–æ–ø–µ—á–∞—Ç–∫–∞, http –≤–º–µ—Å—Ç–æ https)
- –°–æ–±—ã—Ç–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL —Ç–æ—á–Ω–æ: `https://avia-point.com/payments/webhook`
- –í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è

### 2. Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç, –Ω–æ –ø–ª–∞—Ç–µ–∂ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã:**
- –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –ë–î
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ `user_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `payments`
- –û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
- –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é: `migrations/add_user_id_to_payments.sql`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã `payments`

### 3. Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç, –Ω–æ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã:**
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `user_id` –≤ –ø–ª–∞—Ç–µ–∂–µ
- –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ `subscription_type` –∏–ª–∏ `period_days`

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `user_id` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `subscription_type` –∏ `period_days` –≤ metadata

---

## –†–µ–∑—é–º–µ

‚úÖ **Endpoint –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –î–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤–∞–ª–∏–¥–µ–Ω
- Nginx –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
- Backend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç webhook –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç `{"status":"ok"}`

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ!** üöÄ

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ Endpoint –ø—Ä–æ–≤–µ—Ä–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
2. ‚è≥ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å URL –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa
3. ‚è≥ –í—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
4. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø–ª–∞—Ç–µ–∂–æ–º
5. ‚è≥ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

---

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 2025-12-01  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç

