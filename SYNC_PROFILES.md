# ðŸ”„ Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ profiles Ð¼ÐµÐ¶Ð´Ñƒ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ð¸ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ Ð‘Ð”

## ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°

Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° `profiles` Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°ÐµÑ‚ÑÑ Ð¾Ñ‚ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½, Ð¸ Ð²Ñ‹ Ð½Ðµ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð·Ð°Ñ‚ÐµÑ€ÐµÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð½Ð° Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½.

## Ð ÐµÑˆÐµÐ½Ð¸Ðµ

### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ profiles Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ Ð½Ð° Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ)

Ð­Ñ‚Ð¾ Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¹ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½:

```bash
# Ð¡Ð´ÐµÐ»Ð°Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼
chmod +x sync_profiles_from_prod.sh

# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð¿Ñ‚
./sync_profiles_from_prod.sh 83.166.246.205
```

**Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°ÐµÑ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚:**
1. Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ `profiles` Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð°Ð½Ð½Ñ‹Ðµ)
2. ÐžÑ‡Ð¸Ñ‰Ð°ÐµÑ‚ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ `profiles`
3. Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ Ð² Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð‘Ð”

---

### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ (ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ) Ð½Ð° Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½

Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ `profiles` Ð½Ð° Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ (Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»Ñ `telegram` Ð¸ `max`), Ð½Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ:

```bash
# Ð¡Ð´ÐµÐ»Ð°Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼
chmod +x apply_migrations_only_to_prod.sh

# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð¿Ñ‚
./apply_migrations_only_to_prod.sh 83.166.246.205
```

**Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°ÐµÑ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚:**
1. ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ (Ð±ÐµÐ· Ð´Ð°Ð½Ð½Ñ‹Ñ…)
2. ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ 025 (`clear_all_flights_data`) - Ð¾Ð½Ð° ÑƒÐ´Ð°Ð»ÑÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ
3. Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÑ‚ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð² `schema_migrations`

---

## Ð ÑƒÑ‡Ð½Ð¾Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð±

### ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ profiles Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ Ð½Ð° Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ

```bash
# 1. Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½
ssh root@83.166.246.205
docker exec aviapoint-postgres pg_dump -U postgres -d aviapoint \
  -t profiles \
  --data-only \
  --column-inserts > /tmp/profiles_export.sql

# 2. ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð¼Ð°ÑˆÐ¸Ð½Ñƒ
scp root@83.166.246.205:/tmp/profiles_export.sql ./

# 3. ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹
docker exec aviapoint-postgres psql -U postgres -d aviapoint -c "TRUNCATE TABLE profiles CASCADE;"

# 4. Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…
cat profiles_export.sql | docker exec -i aviapoint-postgres psql -U postgres -d aviapoint
```

### ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ 029 (Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ telegram Ð¸ max)

```bash
# ÐÐ° ÑÐµÑ€Ð²ÐµÑ€Ðµ
ssh root@83.166.246.205
cd /home/aviapoint_server

# ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ Ñ‡ÐµÑ€ÐµÐ· Adminer Ð¸Ð»Ð¸ psql
docker exec aviapoint-postgres psql -U postgres -d aviapoint -f migrations/add_telegram_and_max_to_profiles.sql

# Ð—Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ
docker exec aviapoint-postgres psql -U postgres -d aviapoint -c \
  "INSERT INTO schema_migrations (version, name) VALUES ('029', 'add_telegram_and_max_to_profiles') ON CONFLICT (version) DO NOTHING;"
```

---

## Ð’Ð°Ð¶Ð½Ñ‹Ðµ Ð·Ð°Ð¼ÐµÑ‡Ð°Ð½Ð¸Ñ

âš ï¸ **ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ 025 (`clear_all_flights_data`)** ÑƒÐ´Ð°Ð»ÑÐµÑ‚ Ð²ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ Ð¿Ð¾Ð»ÐµÑ‚Ð°Ñ…. ÐžÐ½Ð° Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð° Ð² ÑÐºÑ€Ð¸Ð¿Ñ‚Ðµ `apply_migrations_only_to_prod.sh`.

âœ… **ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ 029 (`add_telegram_and_max_to_profiles`)** Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ `profiles` Ð¸ Ð½Ðµ Ð·Ð°Ñ‚Ñ€Ð°Ð³Ð¸Ð²Ð°ÐµÑ‚ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ.

---

## ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾ÑÐ»Ðµ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸

### ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹

```bash
# Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾
docker exec aviapoint-postgres psql -U postgres -d aviapoint -c "SELECT COUNT(*) FROM profiles;"

# ÐÐ° Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½
ssh root@83.166.246.205
docker exec aviapoint-postgres psql -U postgres -d aviapoint -c "SELECT COUNT(*) FROM profiles;"
```

### ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ñ

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¿Ð¾Ð»ÐµÐ¹ telegram Ð¸ max
docker exec aviapoint-postgres psql -U postgres -d aviapoint -c "\d profiles" | grep -E "telegram|max"
```

---

## Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹

Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ Ð¿ÐµÑ€ÐµÐ´ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹:

```bash
# Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ profiles
docker exec aviapoint-postgres pg_dump -U postgres -d aviapoint \
  -t profiles \
  --data-only \
  --column-inserts > profiles_backup_$(date +%Y%m%d_%H%M%S).sql
```

