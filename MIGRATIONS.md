# Система миграций базы данных

## Описание

Система автоматических миграций с версионированием. Отслеживает выполненные миграции и выполняет только новые.

## Использование

### Выполнить все миграции

```bash
cd aviapoint_server
dart scripts/run_migrations.dart
```

### Показать статус миграций

```bash
dart scripts/run_migrations.dart --status
```

### Откатить последнюю миграцию

```bash
dart scripts/run_migrations.dart --rollback
```

## Как это работает

1. **Таблица `schema_migrations`** - хранит информацию о выполненных миграциях:
   - `version` - версия миграции (уникальный идентификатор)
   - `name` - название миграции
   - `executed_at` - время выполнения

2. **Автоматическое отслеживание** - система проверяет, какие миграции уже выполнены, и выполняет только новые

3. **Порядок выполнения** - миграции выполняются в порядке, указанном в `MigrationManager`

## Добавление новой миграции

1. Создайте SQL файл в папке `migrations/`:
   ```sql
   -- migrations/005_add_new_field.sql
   ALTER TABLE some_table ADD COLUMN new_field VARCHAR(255);
   ```

2. Добавьте информацию о миграции в `lib/core/migrations/migration_manager.dart`:
   ```dart
   _MigrationInfo(
     version: '006',  // Следующий номер
     name: 'add_new_field',
     file: 'migrations/005_add_new_field.sql',
   ),
   ```

3. Запустите миграции:
   ```bash
   dart scripts/run_migrations.dart
   ```

## Автоматические миграции при старте сервера

По умолчанию миграции НЕ выполняются автоматически при старте сервера (для безопасности).

Чтобы включить автоматические миграции, раскомментируйте код в `lib/main.dart`:

```dart
// В функции main(), после подключения к БД:
final migrationManager = MigrationManager(connection: connection);
await migrationManager.runMigrations();
```

## Преимущества этого подхода

✅ **Автоматизация** - не нужно вручную запускать psql  
✅ **Версионирование** - отслеживание выполненных миграций  
✅ **Безопасность** - не выполняет уже выполненные миграции  
✅ **Порядок** - гарантированный порядок выполнения  
✅ **Статус** - можно проверить, какие миграции выполнены  
✅ **Интеграция** - можно запускать при старте сервера  

## Альтернативные подходы

### 1. Ручное выполнение (текущий подход)
```bash
psql -h localhost -U postgres -d aviapoint -f migrations/create_airports_table.sql
```

### 2. Bash скрипт (уже есть)
```bash
./migrations/run_migrations_in_order.sh
```

### 3. Dart скрипт с версионированием (новый подход)
```bash
dart scripts/run_migrations.dart
```

### 4. Автоматически при старте сервера
Раскомментировать код в `main.dart`

## Рекомендации

- **Разработка**: Используйте `dart scripts/run_migrations.dart` для локальной разработки
- **Продакшн**: Выполняйте миграции вручную или через CI/CD перед деплоем
- **Проверка**: Используйте `--status` для проверки состояния миграций

