# –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è AviaPoint —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –ø–ª–∞—Ç–µ–∂–µ–π –ÆKassa.

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `subscription_types` (—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ç–∏–ø–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫)
- `id` - ID —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- `code` - –ö–æ–¥ —Ç–∏–ø–∞ ('monthly', 'quarterly', 'yearly', 'custom')
- `name` - –ù–∞–∑–≤–∞–Ω–∏–µ ('–ú–µ—Å—è—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞', '–ö–≤–∞—Ä—Ç–∞–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞', –∏ —Ç.–¥.)
- `period_days` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏
- `price` - –¶–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- `is_active` - –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏

### –¢–∞–±–ª–∏—Ü–∞ `subscriptions` (–ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- `id` - ID –ø–æ–¥–ø–∏—Å–∫–∏
- `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (FK –∫ profiles)
- `payment_id` - ID –ø–ª–∞—Ç–µ–∂–∞ (FK –∫ payments)
- `subscription_type_id` - ID —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (FK –∫ subscription_types)
- `period_days` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏
- `start_date` - –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- `end_date` - –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
- `is_active` - –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞
- `auto_renew` - –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
- `created_at`, `updated_at` - –î–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `payments`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `user_id` –¥–ª—è —Å–≤—è–∑–∏ –ø–ª–∞—Ç–µ–∂–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ API:
```json
POST /payments/create
{
  "amount": 1000.00,
  "currency": "RUB",
  "description": "–û–ø–ª–∞—Ç–∞ –º–µ—Å—è—á–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ AviaPoint",
  "return_url": "aviapoint://payment/success",
  "cancel_url": "aviapoint://payment/cancel",
  "userId": 123,
  "subscriptionType": "monthly"
}
```

### 2. –û–ø–ª–∞—Ç–∞
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç —á–µ—Ä–µ–∑ –ÆKassa.

### 3. Webhook –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ (`payment.succeeded`):
1. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –≤ –ë–î
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. –¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞:
   - "–º–µ—Å—è—Ü" / "monthly" ‚Üí 30 –¥–Ω–µ–π
   - "–∫–≤–∞—Ä—Ç–∞–ª" / "quarterly" ‚Üí 90 –¥–Ω–µ–π
   - "–≥–æ–¥" / "yearly" ‚Üí 365 –¥–Ω–µ–π

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏:
- `GET /subscriptions/status` - –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
- `GET /subscriptions/active` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ
- `GET /subscriptions/history` - –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫

## üì° API Endpoints

### –ü–æ–¥–ø–∏—Å–∫–∏

#### GET `/subscriptions/status`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Headers:**
```
Authorization: Bearer <token>
```

**Response:**
```json
{
  "has_active_subscription": true
}
```

#### GET `/subscriptions/active`
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ.

**Headers:**
```
Authorization: Bearer <token>
```

**Response:**
```json
{
  "has_active_subscription": true,
  "subscription": {
    "id": 1,
    "period_days": 30,
    "start_date": "2024-01-01T00:00:00Z",
    "end_date": "2024-01-31T23:59:59Z",
    "is_active": true,
    "remaining_days": 15,
    "auto_renew": false
  }
}
```

#### GET `/subscriptions/history`
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Headers:**
```
Authorization: Bearer <token>
```

**Response:**
```json
{
  "subscriptions": [
    {
      "id": 1,
      "payment_id": "2c5d5b87-0001-5000-8000-1d5e5b5b5b5b",
      "period_days": 30,
      "start_date": "2024-01-01T00:00:00Z",
      "end_date": "2024-01-31T23:59:59Z",
      "is_active": false,
      "auto_renew": false,
      "created_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

### –ü–ª–∞—Ç–µ–∂–∏ (–æ–±–Ω–æ–≤–ª–µ–Ω–æ)

#### POST `/payments/create`
–°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂. –¢–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏:

```json
{
  "amount": 1000.00,
  "currency": "RUB",
  "description": "–û–ø–ª–∞—Ç–∞ –º–µ—Å—è—á–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ AviaPoint",
  "return_url": "aviapoint://payment/success",
  "cancel_url": "aviapoint://payment/cancel",
  "userId": 123,
  "subscriptionType": "monthly",
  "periodDays": 30
}
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∏–ø–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫

–¢–∏–ø—ã –ø–æ–¥–ø–∏—Å–æ–∫ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `subscription_types`. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–∑–¥–∞—é—Ç—Å—è:
- –ú–µ—Å—è—á–Ω–∞—è (30 –¥–Ω–µ–π)
- –ö–≤–∞—Ä—Ç–∞–ª—å–Ω–∞—è (90 –¥–Ω–µ–π)
- –ì–æ–¥–æ–≤–∞—è (365 –¥–Ω–µ–π)

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω:
```sql
INSERT INTO subscription_types (code, name, period_days, price) VALUES
    ('custom_60', '–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ 60 –¥–Ω–µ–π', 60, 1500.00);
```

## üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:

```dart
final hasActive = await subscriptionRepository.hasActiveSubscription(userId);
if (!hasActive) {
  // –û—Ç–∫–∞–∑–∞—Ç—å –≤ –¥–æ—Å—Ç—É–ø–µ
}
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–æ–¥ –º–æ–¥–µ–ª–∏:
```dart
final subscription = await subscriptionRepository.getActiveSubscription(userId);
if (subscription == null || !subscription.isCurrentlyActive) {
  // –û—Ç–∫–∞–∑–∞—Ç—å –≤ –¥–æ—Å—Ç—É–ø–µ
}
```

## üìä –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è

–í –ë–î –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è `deactivate_expired_subscriptions()`, –∫–æ—Ç–æ—Ä–∞—è –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –≤—Å–µ –∏—Å—Ç–µ–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏.

–ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ cron):
```sql
SELECT deactivate_expired_subscriptions();
```

–ò–ª–∏ –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ:
```dart
await subscriptionRepository.deactivateExpiredSubscriptions();
```

## üöÄ –ú–∏–≥—Ä–∞—Ü–∏—è

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –º–∏–≥—Ä–∞—Ü–∏—é:
```bash
psql -h localhost -U postgres -d aviapoint -f migrations/create_subscriptions_table.sql
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```sql
-- –°–º. —Ñ–∞–π–ª migrations/create_subscriptions_table.sql
```

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç

- [x] –°–æ–∑–¥–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–æ–¥–µ–ª–∏ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
- [x] –°–æ–∑–¥–∞–Ω –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø–æ–¥–ø–∏—Å–æ–∫
- [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω webhook –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
- [x] –û–±–Ω–æ–≤–ª–µ–Ω PaymentRepository –¥–ª—è —Å–≤—è–∑–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- [x] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ DI
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω–∞ SQL –º–∏–≥—Ä–∞—Ü–∏—è
- [ ] –ó–∞–ø—É—â–µ–Ω build_runner –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è —á–µ—Ä–µ–∑ webhook
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ cron job –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
2. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –î–æ–±–∞–≤—å—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–µ—Ä–µ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –ø–æ–¥–ø–∏—Å–∫–∏
3. **–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ**: –†–µ–∞–ª–∏–∑—É–π—Ç–µ –ª–æ–≥–∏–∫—É –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ (–ø–æ–ª–µ `auto_renew`)
4. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: –î–æ–±–∞–≤—å—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫
5. **–ü—Ä–æ–º–æ–∫–æ–¥—ã**: –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –¥–ª—è —Å–∫–∏–¥–æ–∫

---

**–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ

