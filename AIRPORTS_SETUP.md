# Настройка базы данных аэропортов

## Описание

База данных аэропортов загружается из [АОПА-Россия (maps.aopa.ru)](https://maps.aopa.ru/user/export/) и включает данные об аэродромах и посадочных площадках авиации общего назначения (АОН) России.

## Шаги установки

### 1. Выполнить миграцию

Создайте таблицу `airports` в базе данных:

```bash
psql -h localhost -U postgres -d aviapoint -f migrations/create_airports_table.sql
```

Или через docker:

```bash
docker exec -i aviapoint_postgres psql -U postgres -d aviapoint < migrations/create_airports_table.sql
```

### 2. Получить данные из АОПА-Россия

1. Зарегистрируйтесь на [maps.aopa.ru](https://maps.aopa.ru/)
2. Войдите в систему
3. Перейдите в раздел "Экспорт" → [maps.aopa.ru/user/export/](https://maps.aopa.ru/user/export/)
4. Экспортируйте данные в нужном формате (CSV, JSON и т.д.)
5. Сохраните файл в проект (например, `lib/on_the_way/aopa_airports.csv`)

**Примечание:** Можно настроить регулярное получение обновлений через раздел "Регулярное получение данных".

### 3. Загрузить данные в БД

Запустите скрипт для загрузки данных из АОПА:

```bash
cd aviapoint_server
dart scripts/load_airports_from_aopa.dart --csv /path/to/aopa_export.csv
```

Скрипт:
- Парсит данные из экспорта АОПА-Россия
- Загружает их в таблицу `airports`
- Обновляет существующие записи при конфликте по `ident` (ICAO коду)
- Устанавливает `source = 'aopa'` для всех записей
- Выводит статистику по типам аэропортов

### 4. Сгенерировать код

После создания модели и контроллера нужно сгенерировать код:

```bash
cd aviapoint_server
dart run build_runner build --delete-conflicting-outputs
```

## Структура таблицы

Таблица `airports` включает:

### Основные поля из АОПА-Россия:
- `ident` - ICAO код (например, UUDD) или локальный код
- `type` - тип аэродрома (airport, heliport, seaplane_base, etc.)
- `name` - название
- `latitude_deg`, `longitude_deg` - координаты
- `elevation_ft` - высота над уровнем моря
- `iso_country` - код страны (всегда 'RU' для данных АОПА)
- `iso_region` - регион (RU-MOW, RU-SPE, etc.)
- `municipality` - город/населенный пункт
- `iata_code` - IATA код (если есть)
- `gps_code`, `local_code` - другие коды

### Расширяемые поля:
- `services` (JSONB) - услуги аэропорта (заправка, стоянка, ремонт и т.д.)
- `owner_id` - ID владельца аэропорта из таблицы `profiles` (для будущего функционала)
- `is_verified` - проверен ли аэропорт администрацией
- `is_active` - активен ли аэропорт

## API Endpoints

После настройки доступны следующие endpoints:

- `GET /api/airports?q=query&country=RU&type=airport&limit=50` - поиск аэропортов
- `GET /api/airports/{code}` - получить аэропорт по ICAO коду
- `GET /api/airports/country/{country}?limit=100` - получить все аэропорты страны

## Источник данных

### АОПА-Россия (maps.aopa.ru)

Основной источник данных об аэродромах — [maps.aopa.ru](https://maps.aopa.ru/user/export/), раздел **"Экспорт"**.

**Преимущества:**
- Специализированные данные по аэродромам АОН России
- Актуальная информация от Федерации авиации общего назначения
- Возможность регулярных обновлений
- Официальный источник данных от ФЛАРФ/АОПА-Россия

## Обновление данных

### Из АОПА-Россия:

1. Экспортируйте свежие данные с [maps.aopa.ru/user/export/](https://maps.aopa.ru/user/export/)
2. Запустите скрипт загрузки (он автоматически обновит существующие записи):
   ```bash
   dart scripts/load_airports_from_aopa.dart --csv /path/to/aopa_export.csv
   ```

**Регулярные обновления:**
- Можно настроить автоматическое получение данных через раздел "Регулярное получение данных" на maps.aopa.ru
- Рекомендуется обновлять данные ежемесячно или при появлении новых аэродромов

## Будущие возможности

- Привязка владельцев аэропортов для редактирования данных
- Добавление услуг аэропортов (заправка, стоянка, ремонт и т.д.)
- Верификация аэропортов администрацией
- Геопоиск аэропортов по координатам
- Автоматизация регулярного импорта данных из АОПА-Россия

