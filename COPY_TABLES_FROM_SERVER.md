# üì• –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —Å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î

## –°–ø–æ—Å–æ–± 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç

```bash
# –°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x download_tables_from_server.sh

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç
./download_tables_from_server.sh
```

–ò–ª–∏ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º IP —Å–µ—Ä–≤–µ—Ä–∞:
```bash
./download_tables_from_server.sh 83.166.246.205
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
1. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `payments` –∏ `subscriptions` —Å —Å–µ—Ä–≤–µ—Ä–∞
2. –ö–æ–ø–∏—Ä—É–µ—Ç —Ñ–∞–π–ª –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É
3. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –æ—á–∏—â–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
4. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î
5. –û—á–∏—â–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

---

## –°–ø–æ—Å–æ–± 2: –†—É—á–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥ 1: –≠–∫—Å–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü —Å —Å–µ—Ä–≤–µ—Ä–∞

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh root@83.166.246.205

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ - —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã
cd /home/aviapoint_server
docker exec aviapoint-postgres pg_dump -U postgres -d aviapoint \
  -t payments \
  -t subscriptions \
  --data-only \
  --column-inserts > /tmp/payments_subscriptions_export.sql
```

### –®–∞–≥ 2: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É

```bash
# –° –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
scp root@83.166.246.205:/tmp/payments_subscriptions_export.sql ./
```

### –®–∞–≥ 3: –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```bash
# –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
psql -h localhost -U postgres -d aviapoint << SQL
TRUNCATE TABLE payments CASCADE;
TRUNCATE TABLE subscriptions CASCADE;
SQL
```

**–ò–ª–∏ —á–µ—Ä–µ–∑ Adminer:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ Adminer –ª–æ–∫–∞–ª—å–Ω–æ
2. –í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É `aviapoint`
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "SQL-–∑–∞–ø—Ä–æ—Å"
4. –í—ã–ø–æ–ª–Ω–∏—Ç–µ:
   ```sql
   TRUNCATE TABLE payments CASCADE;
   TRUNCATE TABLE subscriptions CASCADE;
   ```

### –®–∞–≥ 4: –ò–º–ø–æ—Ä—Ç –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î

```bash
# –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
psql -h localhost -U postgres -d aviapoint < payments_subscriptions_export.sql
```

**–ò–ª–∏ —á–µ—Ä–µ–∑ Adminer:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ Adminer –ª–æ–∫–∞–ª—å–Ω–æ
2. –í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É `aviapoint`
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ò–º–ø–æ—Ä—Ç"
4. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª `payments_subscriptions_export.sql`
5. –ù–∞–∂–º–∏—Ç–µ "–í—ã–ø–æ–ª–Ω–∏—Ç—å"

---

## –°–ø–æ—Å–æ–± 3: –ü—Ä—è–º–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ psql

### –í–∞—Ä–∏–∞–Ω—Ç A: –° —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```bash
# –≠–∫—Å–ø–æ—Ä—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞
ssh root@83.166.246.205 "docker exec aviapoint-postgres pg_dump -U postgres -d aviapoint -t payments -t subscriptions" | \
psql -h localhost -U postgres -d aviapoint
```

### –í–∞—Ä–∏–∞–Ω—Ç B: –¢–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —É–∂–µ –µ—Å—Ç—å)

```bash
# –≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã—Ö
ssh root@83.166.246.205 "docker exec aviapoint-postgres pg_dump -U postgres -d aviapoint -t payments -t subscriptions --data-only" | \
psql -h localhost -U postgres -d aviapoint
```

---

## –°–ø–æ—Å–æ–± 4: –ß–µ—Ä–µ–∑ Adminer (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø)

### –≠–∫—Å–ø–æ—Ä—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞:

1. –û—Ç–∫—Ä–æ–π—Ç–µ Adminer –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: `http://83.166.246.205:8082`
2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ë–î
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–≠–∫—Å–ø–æ—Ä—Ç"
4. –í—ã–±–µ—Ä–∏—Ç–µ:
   - **–§–æ—Ä–º–∞—Ç:** SQL
   - **–¢–∞–±–ª–∏—Ü—ã:** `payments`, `subscriptions`
   - **–î–∞–Ω–Ω—ã–µ:** ‚úÖ –î–∞
   - **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** ‚úÖ –î–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
5. –ù–∞–∂–º–∏—Ç–µ "–≠–∫—Å–ø–æ—Ä—Ç"
6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª

### –ò–º–ø–æ—Ä—Ç –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î:

1. –û—Ç–∫—Ä–æ–π—Ç–µ Adminer –ª–æ–∫–∞–ª—å–Ω–æ: `http://localhost:8082`
2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ë–î
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ò–º–ø–æ—Ä—Ç"
4. –í—ã–±–µ—Ä–∏—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
5. –ù–∞–∂–º–∏—Ç–µ "–í—ã–ø–æ–ª–Ω–∏—Ç—å"

---

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### ‚ö†Ô∏è –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü

–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ **–∑–∞–º–µ–Ω–∏—Ç—å** –¥–∞–Ω–Ω—ã–µ –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö, –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –∏—Ö –æ—á–∏—Å—Ç–∏—Ç—å:

```sql
TRUNCATE TABLE payments CASCADE;
TRUNCATE TABLE subscriptions CASCADE;
```

**CASCADE** —É–¥–∞–ª–∏—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å foreign keys).

### ‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¥–∞–Ω–Ω—ã—Ö

–ï—Å–ª–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î —É–∂–µ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏ —Å —Ç–∞–∫–∏–º–∏ –∂–µ ID, –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ:

1. **–û—á–∏—Å—Ç–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º** (—Å–º. –≤—ã—à–µ)
2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ON CONFLICT` –≤ SQL (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### ‚ö†Ô∏è –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–¢–∞–±–ª–∏—Ü–∞ `subscriptions` –º–æ–∂–µ—Ç —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞:
- `payments` (—á–µ—Ä–µ–∑ `payment_id`)
- `profiles` (—á–µ—Ä–µ–∑ `user_id`)
- `subscription_types` (—á–µ—Ä–µ–∑ `subscription_type_id`)

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î.

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π:

```sql
-- –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
SELECT 
  (SELECT COUNT(*) FROM payments) as payments_count,
  (SELECT COUNT(*) FROM subscriptions) as subscriptions_count;

-- –í –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
SELECT 
  (SELECT COUNT(*) FROM payments) as payments_count,
  (SELECT COUNT(*) FROM subscriptions) as subscriptions_count;
```

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å.

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏
SELECT id, user_id, status, paid, subscription_type, period_days, created_at 
FROM payments 
ORDER BY created_at DESC 
LIMIT 10;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
SELECT id, user_id, payment_id, subscription_type_id, period_days, is_active, start_date, end_date 
FROM subscriptions 
ORDER BY created_at DESC 
LIMIT 10;
```

---

## –ë—ã—Å—Ç—Ä–∞—è –∫–æ–º–∞–Ω–¥–∞ (–≤—Å–µ –≤ –æ–¥–Ω–æ–º)

```bash
# –≠–∫—Å–ø–æ—Ä—Ç, –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π
ssh root@83.166.246.205 "docker exec aviapoint-postgres pg_dump -U postgres -d aviapoint -t payments -t subscriptions --data-only" | \
psql -h localhost -U postgres -d aviapoint
```

---

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞: "relation does not exist"

**–ü—Ä–∏—á–∏–Ω–∞:** –¢–∞–±–ª–∏—Ü—ã –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î.

**–†–µ—à–µ–Ω–∏–µ:** –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü:
```bash
psql -h localhost -U postgres -d aviapoint -f migrations/create_payments_table.sql
psql -h localhost -U postgres -d aviapoint -f migrations/create_subscriptions_table.sql
```

### –û—à–∏–±–∫–∞: "foreign key constraint"

**–ü—Ä–∏—á–∏–Ω–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏).

**–†–µ—à–µ–Ω–∏–µ:** 
- –õ–∏–±–æ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- –õ–∏–±–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `SET FOREIGN_KEY_CHECKS=0` (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

### –û—à–∏–±–∫–∞: "duplicate key value"

**–ü—Ä–∏—á–∏–Ω–∞:** –í –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î —É–∂–µ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏ —Å —Ç–∞–∫–∏–º–∏ –∂–µ ID.

**–†–µ—à–µ–Ω–∏–µ:** –û—á–∏—Å—Ç–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º:
```sql
TRUNCATE TABLE payments CASCADE;
TRUNCATE TABLE subscriptions CASCADE;
```

---

**–ì–æ—Ç–æ–≤–æ!** –¢–µ–ø–µ—Ä—å –≤—ã –∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã —Å —Å–µ—Ä–≤–µ—Ä–∞! üì•

